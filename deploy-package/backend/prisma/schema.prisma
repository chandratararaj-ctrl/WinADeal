// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CUSTOMER
  VENDOR
  DELIVERY
  ADMIN
}

enum OrderStatus {
  PLACED
  ACCEPTED
  REJECTED
  PREPARING
  READY
  ASSIGNED
  EN_ROUTE_TO_PICKUP
  PICKED_UP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  ONLINE
  COD
  WALLET
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum DocumentType {
  GST_CERTIFICATE
  FSSAI_LICENSE
  SHOP_LICENSE
  ID_PROOF
  DRIVING_LICENSE
  VEHICLE_RC
  PHOTO
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum DiscountType {
  PERCENTAGE
  FLAT
}

enum CategoryType {
  FOOD
  GROCERY
  OTHER
}

// ============================================
// MODELS
// ============================================

model City {
  id          String   @id @default(uuid())
  name        String   @unique
  state       String   @default("West Bengal")
  isActive    Boolean  @default(true)
  displayOrder Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([name])
}

model User {
  id            String     @id @default(uuid())
  roles         UserRole[] // Changed from single role to array of roles
  name          String
  email         String?    @unique
  phone         String     @unique
  passwordHash  String?
  otp           String?
  otpExpiresAt  DateTime?
  isVerified    Boolean    @default(false)
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  shop              Shop?
  deliveryPartner   DeliveryPartner?
  addresses         Address[]
  orders            Order[]          @relation("CustomerOrders")
  reviews           Review[]
  walletTransactions WalletTransaction[]
  documents         Document[]
  settingChanges    SettingHistory[] // Relation to setting history

  @@index([phone])
  @@index([email])
  // Note: Cannot index array fields in PostgreSQL with Prisma
}

model Shop {
  id                String    @id @default(uuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name              String
  description       String?
  categoryId        String
  category          Category  @relation(fields: [categoryId], references: [id])
  address           String
  city              String    @default("") // Added city field
  latitude          Float
  longitude         Float
  deliveryRadiusKm  Int       @default(5)
  avgPrepTimeMins   Int       @default(30)
  isOpen            Boolean   @default(false)
  isVerified        Boolean   @default(false)
  commissionRate    Float     @default(20.0)
  rating            Float     @default(0.0)
  totalOrders       Int       @default(0)
  gstin             String?
  fssaiNumber       String?
  bankAccountNumber String?
  bankIfscCode      String?
  bankAccountName   String?
  rejectionReason   String?
  openingTime       String?   // e.g., "09:00"
  closingTime       String?   // e.g., "22:00"
  minOrderAmount    Float     @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  products          Product[]
  orders            Order[]
  payouts           Payout[]

  @@index([categoryId])
  @@index([isVerified])
  @@index([isOpen])
}

model DeliveryPartner {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicleType     String    // bike, scooter, cycle
  vehicleNumber   String?
  city            String
  zone            String?
  isOnline        Boolean   @default(false)
  isVerified      Boolean   @default(false)
  commissionRate  Float     @default(15.0) // Commission percentage on delivery earnings
  totalEarnings   Float     @default(0.0)  // Lifetime earnings tracking
  rating          Float     @default(0.0)
  totalDeliveries Int       @default(0)
  bankAccountNumber String?
  bankIfscCode      String?
  bankAccountName   String?
  
  // Current Location (for idle/online state)
  currentLatitude  Float?
  currentLongitude Float?
  lastLocationUpdate DateTime?
  
  // Penalty tracking
  rejectionCount  Int       @default(0)
  penaltyAmount   Float     @default(0.0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  deliveries      Delivery[]
  payouts         Payout[]
  requests        DeliveryRequest[]

  @@index([isOnline])
  @@index([isVerified])
  @@index([city])
  @@index([currentLatitude, currentLongitude])
}

model Category {
  id          String       @id @default(uuid())
  name        String
  type        CategoryType
  icon        String?
  parentId    String?
  parent      Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]   @relation("CategoryHierarchy")
  displayOrder Int         @default(0)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  shops       Shop[]
  products    Product[]

  @@index([type])
  @@index([parentId])
}

model Product {
  id              String    @id @default(uuid())
  shopId          String
  shop            Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  categoryId      String
  category        Category  @relation(fields: [categoryId], references: [id])
  name            String
  description     String?
  price           Float
  discountedPrice Float?
  isVeg           Boolean   @default(true)
  isAvailable     Boolean   @default(true)
  stockQuantity   Int?
  images          String[]  @default([])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  variants        ProductVariant[]
  orderItems      OrderItem[]

  @@index([shopId])
  @@index([categoryId])
  @@index([isAvailable])
}

model ProductVariant {
  id            String   @id @default(uuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name          String   // e.g., "Small", "Medium", "Large"
  priceModifier Float    // e.g., -10, 0, +20
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([productId])
}

model Order {
  id                    String        @id @default(uuid())
  orderNumber           String        @unique
  customerId            String
  customer              User          @relation("CustomerOrders", fields: [customerId], references: [id])
  shopId                String
  shop                  Shop          @relation(fields: [shopId], references: [id])
  status                OrderStatus   @default(PLACED)
  deliveryAddressId     String
  deliveryAddress       Address       @relation(fields: [deliveryAddressId], references: [id])
  subtotal              Float
  deliveryFee           Float
  discount              Float         @default(0)
  tax                   Float

  total                 Float
  commissionAmount      Float         @default(0) // Calculated commission for platform
  vendorEarnings        Float         @default(0) // Amount creditable to vendor
  paymentMethod         PaymentMethod
  paymentStatus         PaymentStatus @default(PENDING)
  paymentTransactionId  String?
  couponCode            String?
  specialInstructions   String?
  scheduledAt           DateTime?
  estimatedDeliveryAt   DateTime?
  prepTimeMinutes       Int?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relations
  orderItems            OrderItem[]
  delivery              Delivery?
  review                Review?
  deliveryRequests      DeliveryRequest[]

  @@index([customerId])
  @@index([shopId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id                  String   @id @default(uuid())
  orderId             String
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId           String
  product             Product  @relation(fields: [productId], references: [id])
  quantity            Int
  price               Float    // Price at the time of order
  specialInstructions String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
}

model Delivery {
  id                  String           @id @default(uuid())
  orderId             String           @unique
  order               Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  deliveryPartnerId   String
  deliveryPartner     DeliveryPartner  @relation(fields: [deliveryPartnerId], references: [id])
  
  // Timing
  pickupTime          DateTime?
  deliveryTime        DateTime?
  estimatedDeliveryAt DateTime?
  
  // Payment
  deliveryFee         Float
  tip                 Float            @default(0)
  commissionAmount    Float            @default(0) // Commission deducted from delivery earnings
  partnerEarnings     Float            @default(0) // Net amount for delivery partner
  
  // Verification
  deliveryOtp         String?
  verificationCode    String?   // 6â€‘digit code for delivery confirmation
  deliveryProofPhoto  String?
  
  // GPS Tracking
  currentLatitude     Float?
  currentLongitude    Float?
  lastLocationUpdate  DateTime?
  routePolyline       String?          // Encoded polyline for route
  distanceKm          Float?           // Total distance
  etaMinutes          Int?             // Estimated time of arrival
  
  // Status tracking
  isTracking          Boolean          @default(false)
  trackingStartedAt   DateTime?
  
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  // Relations
  locationHistory     DeliveryLocation[]

  @@index([deliveryPartnerId])
  @@index([orderId])
  @@index([isTracking])
}

// New model for tracking location history
model DeliveryLocation {
  id          String   @id @default(uuid())
  deliveryId  String
  delivery    Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  latitude    Float
  longitude   Float
  speed       Float?   // Speed in km/h
  heading     Float?   // Direction in degrees
  accuracy    Float?   // Accuracy in meters
  timestamp   DateTime @default(now())

  @@index([deliveryId])
  @@index([timestamp])
}

model Address {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label        String   // home, work, other
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  pincode      String
  latitude     Float?
  longitude    Float?
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  orders       Order[]

  @@index([userId])
}

model Review {
  id          String   @id @default(uuid())
  orderId     String   @unique
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // Rating details
  shopRating          Int?     // 1-5 rating for shop
  productRating       Int?     // 1-5 rating for product quality
  deliveryRating      Int?     // 1-5 rating for delivery
  overallRating       Int      // 1-5 overall rating (calculated or direct)
  
  // Review content
  comment             String?
  images              String[] @default([]) // Array of image URLs
  
  // Target information
  targetType          String   // shop, delivery, product
  targetId            String
  
  // Vendor response
  vendorResponse      String?
  vendorResponseAt    DateTime?
  
  // Moderation
  isApproved          Boolean  @default(true)
  isFlagged           Boolean  @default(false)
  moderationNote      String?
  
  // Engagement
  helpfulCount        Int      @default(0)
  notHelpfulCount     Int      @default(0)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([targetType, targetId])
  @@index([userId])
  @@index([isApproved])
  @@index([createdAt])
}

model Document {
  id              String         @id @default(uuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            DocumentType
  fileUrl         String
  status          DocumentStatus @default(PENDING)
  rejectionReason String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([status])
}

model WalletTransaction {
  id            String          @id @default(uuid())
  userId        String
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          TransactionType
  amount        Float
  description   String
  balanceAfter  Float
  createdAt     DateTime        @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Coupon {
  id             String       @id @default(uuid())
  code           String       @unique
  discountType   DiscountType
  discountValue  Float
  minOrderValue  Float        @default(0)
  maxDiscount    Float?
  validFrom      DateTime
  validTo        DateTime
  usageLimit     Int?
  usedCount      Int          @default(0)
  isActive       Boolean      @default(true)
  categoryId     String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([code])
  @@index([isActive])
}

model AppConfig {
  id    String @id @default(uuid())
  key   String @unique
  value String
  updatedAt DateTime @updatedAt
}

enum PayoutStatus {
  PENDING
  PROCESSED
  REJECTED
  FAILED
}

enum PayoutMethod {
  BANK_TRANSFER
  UPI
  CASH
}

enum PayoutCycleType {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum PayoutCycleStatus {
  ACTIVE
  CLOSED
  PROCESSING
  COMPLETED
}

model PayoutCycle {
  id              String             @id @default(uuid())
  name            String             // e.g., "Week 1 Jan 2026"
  cycleType       PayoutCycleType
  startDate       DateTime
  endDate         DateTime
  status          PayoutCycleStatus  @default(ACTIVE)
  totalPayouts    Int                @default(0)
  totalAmount     Float              @default(0)
  processedAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  // Relations
  payouts         Payout[]

  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model Payout {
  id                String          @id @default(uuid())
  shopId            String?
  shop              Shop?           @relation(fields: [shopId], references: [id])
  deliveryPartnerId String?
  deliveryPartner   DeliveryPartner? @relation(fields: [deliveryPartnerId], references: [id])
  payoutCycleId     String?
  payoutCycle       PayoutCycle?    @relation(fields: [payoutCycleId], references: [id])
  
  grossAmount       Float           // Amount before commission deduction
  commissionRate    Float           // Commission rate applied at time of payout
  amount            Float           // Net payout amount
  currency          String          @default("INR")
  status            PayoutStatus    @default(PENDING)
  method            PayoutMethod    @default(BANK_TRANSFER)
  transactionRef    String?
  notes             String?
  
  processedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([shopId])
  @@index([deliveryPartnerId])
  @@index([payoutCycleId])
  @@index([status])
}

model CommissionHistory {
  id              String   @id @default(uuid())
  entityType      String   // VENDOR, DELIVERY_PARTNER
  entityId        String   // shopId or deliveryPartnerId
  oldRate         Float
  newRate         Float
  changedBy       String   // userId who made the change
  reason          String?
  createdAt       DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

model SettingHistory {
  id        String   @id @default(uuid())
  key       String
  oldValue  String?
  newValue  String
  changedBy String
  user      User     @relation(fields: [changedBy], references: [id])
  createdAt DateTime @default(now())

  @@index([key])
  @@index([createdAt])
}

enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMED_OUT
  EXPIRED
}

model DeliveryRequest {
  id                String          @id @default(uuid())
  orderId           String
  order             Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  deliveryPartnerId String
  deliveryPartner   DeliveryPartner @relation(fields: [deliveryPartnerId], references: [id])
  status            RequestStatus   @default(PENDING)
  
  // Timer logic
  createdAt         DateTime        @default(now())
  expiresAt         DateTime        // When this specific request times out
  respondedAt       DateTime?       // When partner accepted/rejected
  
  // Assignment logic
  isExclusive       Boolean         @default(true) // True for round-robin, False for broadcast
  attemptNumber     Int             @default(1)    // Which attempt in the sequence
  
  // Penalty tracking
  penaltyApplied    Boolean         @default(false)
  penaltyAmount     Float           @default(0)
  
  @@index([orderId])
  @@index([deliveryPartnerId])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
}

model CityCommission {
  id                      String   @id @default(uuid())
  city                    String   @unique
  
  // Vendor commission (percentage of order subtotal)
  vendorCommissionRate    Float    @default(10.0) // Default 10%
  
  // Delivery partner commission (percentage of delivery fee)
  deliveryCommissionRate  Float    @default(15.0) // Default 15%
  
  // Optional: Minimum order amount for this city
  minOrderAmount          Float?
  
  // Delivery Configuration
  baseDeliveryFee         Float?   // Base delivery fee for this city
  perKmDeliveryFee        Float?   // Per km delivery fee for this city
  baseDistance            Float?   // Base distance in km (free delivery up to this distance)
  maxDeliveryRadius       Float?   // Maximum delivery radius in km
  
  // Tax configuration
  taxRate                 Float?   // Tax rate percentage for this city
  
  isActive                Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  @@index([city])
  @@index([isActive])
}

